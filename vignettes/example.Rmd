---
title: "BTIPFlow example"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{BTIPFlow example}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r Setup}
library(BTIPFlow)

get_fcs_resultsQC(QC_folder = "./RG Microbiome -APCs panel/resultsQC/", 
                  raw_folder = "../20200810NJ-ACEFlow/good/") -> cs

```

```{r}
gs <- GatingSet(cs)
sampleNames(gs)[6] <- "APCs_CD11C FMO_QC.fcs"
sampleNames(gs)[9] <- "APCs_CD45 FMO_QC.fcs"
markernames(gs[[1:24]])[[4]] <- "CD80"
markernames(gs[[1:24]])[[7]] <- "Live dead"

pData(gs) <- cbind(pData(gs),row.names(pData(gs)))
colnames(pData(gs))[2] <- "tube names"
for (i in 1:length(gs)) {
  pData(gs[[i]])$`tube names` <- keyword(gs[[i]])$`TUBE NAME`
}

set_scatter_gate(gating_set = gs,
                 gate_coordinates = c(2.0e+04, 2.0e+04,
                                      1.4e+04, 1.5e+04,
                                      1.4e+04, 0.2e+04,
                                      3.0e+04, 0.2e+04,
                                      3.0e+04, 2.0e+04),
                 gate_name = "scatter")
set_scatter_gate(gating_set = gs, 
                 gate_coordinates = c(0.01e+05, 1.5e+05,
                                      0.01e+05, 1.0e+05,
                                      0.12e+05, 1.0e+05,
                                      0.12e+05, 1.5e+05),
                 gate_name = "beads"
                 )

set_scatter_gate(gating_set = gs, 
                 gate_coordinates = c(0.7e+05, 0.4e+05,
                                      0.7e+05, 0.01e+05,
                                      0.95e+05, 0.01e+05,
                                      0.95e+05, 0.4e+05),
                 gate_name = "FSC-singlet", 
                 parent = "scatter",
                 dimensions = list("FSC-W", "FSC-H")
)

set_scatter_gate(gating_set = gs, 
                 gate_coordinates = c(0.4e+05, 0.3e+05,
                                      0.4e+05, 0.01e+05,
                                      0.70e+05, 0.01e+05,
                                      0.70e+05, 0.3e+05),
                 gate_name = "SSC-singlet", 
                 parent = "FSC-singlet",
                 dimensions = list("SSC-W", "SSC-H")
)

make_gates_from_fmos(gating_set = gs, parent = "SSC-singlet", trim = 1)

pdf("gating_tree.pdf")
plot(gs)
dev.off()

nodes <- gs_get_pop_paths(gs, path = "auto")[2:4]
length(gs) %>% sqrt() %>% round() -> hw
hw <- hw*2
pdf("Root Scatter Plots.pdf", hw, hw)
ggcyto(gs, 
       aes(`FSC-A`, `SSC-A`), 
       subset = "root", 
       filter = marginalFilter) + 
  geom_bin2d(bins = 256) + 
  ggcyto_par_set(limits = "instrument") +
  geom_gate("scatter") + 
  geom_stats("scatter", type = "percent", adjust = 0.8) +
  labs(title = "Root Scatter Plots") +
  facet_wrap(~`tube names`)
dev.off()
pdf("FSC-singlet Plots.pdf", hw, hw)
ggcyto(gs, 
       aes(`FSC-W`, `FSC-H`), 
       subset = "scatter", 
       filter = marginalFilter) + 
  geom_bin2d(bins = 256) + 
  ggcyto_par_set(limits = "instrument") +
  geom_gate("FSC-singlet") + 
  geom_stats("FSC-singlet", type = "percent", adjust = 0.1) +
  labs(title = "FSC-singlet Plots") +
  facet_wrap(~`tube names`)
dev.off()
pdf("SSC-singlet Plots.pdf", hw, hw)
ggcyto(gs, 
       aes(`SSC-W`, `SSC-H`), 
       subset = "FSC-singlet", 
       filter = marginalFilter) + 
  geom_bin2d(bins = 256) + 
  ggcyto_par_set(limits = "instrument") +
  geom_gate("SSC-singlet") + 
  geom_stats("SSC-singlet", type = "percent", adjust = 0.1) +
  labs(title = "SSC-singlet Plots") +
  facet_wrap(~`tube names`)
dev.off()

pops <- gs_get_pop_paths(gs, path = "auto")
for (i in 7:13) {
  file_name <- paste(pops[i], ".pdf", sep = "")
  param <- (gs_pop_get_gate(gs[[1]], pops[i])[[1]] %>% parameters())[[1]]
  ggcyto(gs, 
         aes_(param, "SSC-A"), 
         subset = pops[6]) + 
    geom_bin2d(bins = 256) + 
    scale_x_flowjo_biexp(neg = 1, widthBasis = -20) +
    geom_gate(pops[i]) + 
    geom_stats(pops[i], type = "percent", adjust = 0.1) +
    labs(title = paste(pops[i], "Plots"), 
         subtitle = "Gated per FMO") +
    facet_wrap(~`tube names`)
  ggsave(file_name, width = hw, height = hw)
}

```

